---
import Nav from "../components/Nav.astro";
import { ClientRouter } from "astro:transitions";
import "../styles/global.css";

const { title = "" } = Astro.props;
const {
	description = "Jeff Herrera is a NYC-based creative director shaping brand, physical, and digital experiences.",
	ogImage = "/images/seo-image.webp",
} = Astro.props;
const fullTitle =
	title && title.toLowerCase() !== "home"
		? `Jeff Herrera â€” ${title}`
		: "Jeff Herrera";
const canonical = new URL(Astro.url.pathname, Astro.site ?? Astro.url).toString();
const ogImageUrl = new URL(ogImage, Astro.site ?? Astro.url).toString();
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<meta name="description" content={description} />
		<link rel="canonical" href={canonical} />
		<meta property="og:type" content="website" />
		<meta property="og:title" content={fullTitle} />
		<meta property="og:description" content={description} />
		<meta property="og:url" content={canonical} />
		<meta property="og:image" content={ogImageUrl} />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={fullTitle} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={ogImageUrl} />
		<title>{fullTitle}</title>
		<ClientRouter />
	</head>
	<body>
		<Nav />
		<main class="">
			<slot />
		</main>
		<script is:inline>
			const setupReveal = () => {
				const revealElements = document.querySelectorAll(".reveal");
				if (revealElements.length === 0) return;

				try {
					const prefersReducedMotion = window.matchMedia(
						"(prefers-reduced-motion: reduce)"
					);

					if (prefersReducedMotion.matches) {
						revealElements.forEach((element) =>
							element.classList.add("is-inview")
						);
						return;
					}

					const observer = new IntersectionObserver(
						(entries, observerInstance) => {
							entries.forEach((entry) => {
								const element = entry.target;
								const isOnce = element.classList.contains("reveal--once");

								if (entry.isIntersecting) {
									element.classList.add("is-inview");
									if (isOnce) observerInstance.unobserve(element);
								} else if (!isOnce) {
									element.classList.remove("is-inview");
								}
							});
						},
						{
							threshold: 0,
							rootMargin: "0px",
						}
					);

					revealElements.forEach((element) => observer.observe(element));
				} catch {
					// Fallback: never hide content if observer setup fails.
					revealElements.forEach((element) => element.classList.add("is-inview"));
				}
			};

			setupReveal();
			document.addEventListener("astro:page-load", setupReveal);
		</script>
		<script>
			import { gsap } from "gsap";

			const setupCursorLag = () => {
				const cursorTargets = document.querySelectorAll("[data-cursor-target]");
				cursorTargets.forEach((card) => {
					const cursor = card.querySelector(".cursor-icon");
					if (!cursor || card.dataset.cursorBound === "true") return;
					card.dataset.cursorBound = "true";

					const target = { x: 0, y: 0 };
					const current = { x: 0, y: 0 };
					let isTracking = false;

					const tick = () => {
						if (!isTracking) return;
						current.x += (target.x - current.x) * 0.16;
						current.y += (target.y - current.y) * 0.16;
						gsap.set(cursor, { left: current.x, top: current.y });
					};

					const updateCursor = (event) => {
						const rect = card.getBoundingClientRect();
						target.x = event.clientX - rect.left;
						target.y = event.clientY - rect.top;
					};

					card.addEventListener("mouseenter", (event) => {
						card.classList.add("is-cursor-active");
						updateCursor(event);
						current.x = target.x;
						current.y = target.y;
						gsap.set(cursor, { left: current.x, top: current.y });
						if (!isTracking) {
							isTracking = true;
							gsap.ticker.add(tick);
						}
					});
					card.addEventListener("mousemove", updateCursor);
					card.addEventListener("mouseleave", () => {
						card.classList.remove("is-cursor-active");
						isTracking = false;
						gsap.ticker.remove(tick);
					});
				});
			};

			setupCursorLag();
			document.addEventListener("astro:page-load", setupCursorLag);
		</script>
	</body>
</html>

<style>
	main {
		margin-top: 96px;
	}

	@media (max-width: 800px) {
		main {
			margin-top: 64px;
		}
	}
</style>
